generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

model User {
  id        Int       @id @default(autoincrement())
  email     String    @unique
  password  String    // hashed password
  name      String
  role      UserRole  @default(USER)
  isActive  Boolean   @default(true)
  
  // Invitation tracking
  invitedBy    Int?
  inviter      User?     @relation("UserInvitations", fields: [invitedBy], references: [id])
  invitedUsers User[]    @relation("UserInvitations")
  
  // Password reset
  passwordResetTokens PasswordResetToken[]
  
  // First login and password change tracking
  mustChangePassword Boolean  @default(false)
  lastPasswordChange DateTime?
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([email])
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

model PasswordChangeOTP {
  id        Int      @id @default(autoincrement())
  otp       String
  userId    Int
  email     String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([otp])
  @@index([userId])
}

model Part {
  id           Int       @id @default(autoincrement())
  partNumber   String    @unique
  itemName     String
  description  String?
  hsnCode      String
  gstPercent   Float     // e.g. 18
  unit         String    // Nos, Ltr, etc.
  mrp          Decimal?  @db.Decimal(10, 2)
  rtl          Decimal?  @db.Decimal(10, 2)
  barcode      String?   @unique
  qrCode       String?   @unique
  isDeleted    Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  invoiceItems          InvoiceItem[]
  inventoryTransactions InventoryTransaction[]
}

model Supplier {
  id            Int       @id @default(autoincrement())
  name          String
  email         String?
  contactPerson String?
  address       String?
  phone         String?
  gstin         String?
  state         String?
  stateCode     String?
  isDeleted     Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  purchaseInvoices Invoice[] @relation("SupplierInvoices")
}

model Customer {
  id        Int       @id @default(autoincrement())
  indexId   String?   @unique
  name      String
  email     String?
  address   String?
  phone     String?
  gstin     String?
  state     String?
  stateCode String?
  isDeleted Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  salesInvoices Invoice[] @relation("CustomerInvoices")
}

enum InvoiceType {
  PURCHASE
  SALE
}

enum InvoiceStatus {
  DRAFT
  SUBMITTED
  PAID
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
  ON_CREDIT
}

model Invoice {
  id           Int          @id @default(autoincrement())
  invoiceNumber String
  type         InvoiceType
  status       InvoiceStatus @default(DRAFT)
  date         DateTime

  supplierId  Int?
  supplier    Supplier?    @relation("SupplierInvoices", fields: [supplierId], references: [id])
  customerId  Int?
  customer    Customer?    @relation("CustomerInvoices", fields: [customerId], references: [id])

  subtotal       Decimal   @db.Decimal(12, 2)
  discountPercent Float?   // e.g. 5 for 5%
  discountAmount  Decimal  @db.Decimal(12, 2)
  taxableValue    Decimal  @db.Decimal(12, 2)
  cgstPercent     Float?
  cgstAmount      Decimal  @db.Decimal(12, 2)
  sgstPercent     Float?
  sgstAmount      Decimal  @db.Decimal(12, 2)
  roundOff        Decimal  @db.Decimal(12, 2)
  total           Decimal  @db.Decimal(12, 2)
  note            String?

  // Additional invoice details
  deliveryNote      String?
  buyerOrderNo      String?
  dispatchDocNo     String?
  deliveryNoteDate  DateTime?
  dispatchedThrough String?
  termsOfDelivery   String?

  // Payment tracking
  paymentStatus  PaymentStatus @default(UNPAID)
  paidAmount     Decimal       @default(0) @db.Decimal(12, 2)
  dueAmount      Decimal?      @db.Decimal(12, 2)
  paymentDate    DateTime?
  paymentMethod  String?
  paymentNote    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items InvoiceItem[]
}

model InvoiceItem {
  id        Int      @id @default(autoincrement())
  invoiceId Int
  invoice   Invoice  @relation(fields: [invoiceId], references: [id])

  partId    Int
  part      Part     @relation(fields: [partId], references: [id])

  hsnCode   String
  quantity  Int
  unit      String
  rate      Decimal  @db.Decimal(10, 2)
  amount    Decimal  @db.Decimal(12, 2)

  createdAt DateTime @default(now())

  inventoryTransactions InventoryTransaction[]
}

enum InventoryDirection {
  IN    // Purchase, stock in
  OUT   // Sale, stock out
}

model InventoryTransaction {
  id            Int                 @id @default(autoincrement())
  partId        Int
  part          Part                @relation(fields: [partId], references: [id])
  invoiceItemId Int?
  invoiceItem   InvoiceItem?        @relation(fields: [invoiceItemId], references: [id])

  direction     InventoryDirection
  quantity      Int
  createdAt     DateTime            @default(now())

  @@index([partId])
}
